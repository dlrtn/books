- 테이블 압축은 운영체제나 하드웨어에 대한 제약 없이 사용할 수 있기 때문에 페이지 압축보단 일반적으로 더 활용도가 높은 편이다.

- 디스크의 데이터 파일의 크기를 줄일 수 있기 때문에 그만큼의 이득은 있으나 다음과 같은 단점이 있다.

    - 버퍼 풀 공간 활용률이 낮다.

    - 쿼리 처리 성능이 낮다.

    - 빈번한 데이터 변경 시 압축률이 떨어진다.

### 1. 압축 테이블 생성

---

- 테이블 압축을 사용하기 위한 전제 조건으로 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용해야 한다.

    - 이를 위해 `innodb_file_per_table` 시스템 변수가 `ON`이어야 한다.

- 테이블 압축을 사용하는 테이블은 다음과 같이 테이블을 생성할 때 `ROW_FORMAT=COMPRESSED` 옵션을 명시해야 한다.

    - 추가로 `KEY_BLOCK_SIZE` 옵션을 사용해서 압축될 페이지의 타깃 크기를 설정하는 데, `2n`으로만 설정할 수 있다.

    - 즉, InnoDB 스토리지 엔진의 페이지 크기가 `16 KB`라면 `KEY_BLOCK_SIZE`는 `4 KB`, `8 KB`만 설정할 수 있음, `32 KB`, `64 KB`인 경우는 사용할 수 없다.

- `KEY_BLOCK_SIZE`만 명시를 해주어도 `ROW_FORMAT=COMPRESSED`는 자동으로 추가되어 생성된다.

> 데이터 페이지를 압축한 용량이 얼마가 될지 알 수 없는데, 어떻게 `KEY_BLOCK_SIZE`를 테이블을 생성할 때 설정할 수 있을까?

1. `16 KB`의 데이터 페이지를 압축
    1. 압축된 결과가 `8 KB` 이하이면 그대로 디스크에 저장(압축 완료)
    2. 압축된 결과가 `8 KB` 초과하면 원본 페이지를 스플릿해서 2개의 페이지에 `8 KB`씩 저장
2. 나뉜 페이지 각각에 대해 1번 단계를 반복 실행

> 스토리지 엔진 내부에서만 일어나며 가장 중요한 것은 원본 데이터 페이지의 압축 결과가 목표 크기보다 작거나 같을 때까지 반복해서 페이지를 스플릿하는 것이다.
>

### 2. KEY_BLOCK_SIZE 결정

---

- 테이블 압축에서 가장 중요한 부분은 압축된 결과를 대략 예측해서 `KEY_BLOCK_SIZE`를 결정하는 것이다.

- 일반적으로 테이블 압축을 적용하기 전에 `KEY_BLOCK_SIZE`를 `4 KB`, `8 KB`로 생성해서 샘플 데이터를 저장해보고 적절한지 판단하는 것이 좋다.

- 이때 샘플 데이터가 많으면 많을수록 더 정확한 테스트가 가능한데, 데이터 페이지가 10개는 생성되도록 테스트 데이터를 `INSERT`해보는 것이 좋다.

### 3. 압축된 페이지의 버퍼 풀 적재 및 사용

---

- `InnoDB 스토리지 엔진`은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재할 때, 압축 버전과 압축이 해제된 버전 2개로 관리한다.

- 이는 앞서 살펴본 `LRU 리스트`와 `Unzip_LRU 리스트`로 별도로 관리한다.

- MySQL 서버에는 압축된 테이블과 압축되지 않은 테이블이 공존하므로 결국 `LRU 리스트`는 다음과 같이 압축된 페이지와 압축되지 않은 페이지를 모두 가질 수 있다.
    - 압축이 적용되지 않은 테이블의 데이터 페이지
    - 압축이 적용된 테이블의 압축된 데이터 페이지

- `Unzip_LRU 리스트`는 압축되지 않은 테이블의 데이터 페이지를 가지지 않으며 압축된 테이블에서 읽은 데이터 페이지만 관리한다.

  ⇒ 이는 `InnoDB 스토리지 엔진`이 압축된 테이블에 대해서는 버퍼 풀의 공간을 이중으로 사용함으로써 메모리를 낭비하게 된다.

  ⇒ 압축된 페이지에서 데이터를 읽거나 변경하기 위해 압축을 해제해야한다는 것인데, 이는 `CPU`를 상대적으로 많이 소모하는 작업이기 때문이다.

- 이런 이유로 `Unzip_LRU 리스트`를 별도로 관리하고 있다가 MySQL 서버로 유입되는 요청 패턴에 따라 적절히 다음과 같은 처리를 수행한다.

    - `InnoDB 버퍼 풀`의 공간이 필요한 경우, `LRU 리스트`의 원본 데이터 페이지는 유지하고, `Unzip_LRU 리스트`의 압축 해제된 버전을 제거해서 버퍼 풀의 공간을 확보한다.
    - 압축된 데이터 페이지가 자주 사용되는 공간일 경우 `Unzip_LRU 리스트`에 압축 해제된 페이지를 계속 유지하면서 압축 및 압축 해제 작업을 최소화한다.
    - 압축된 데이터 페이지가 사용되지 않아서 `LRU 리스트`에서 제거되는 경우에는 `Unzip_LRU 리스트`에서도 제거한다.

- `InnoDB 스토리지 엔진`은 버퍼 풀에서 압축 해제된 버전의 데이터 페이지를 적절한 수준으로 유지하기 위해 `Adaptive 알고리즘`을 사용한다.

- `CPU 사용량`이 높은 서버에서는 가능하면 압축과 압축 해제를 피하기 위해 `Unzip_LRU`의 비율을 높여서 유지한다.

- `Disk IO 사용량`이 높은 서버에서는 가능하면 `Unzip_LRU 리스트`의 비율을 낮춰서 `InnoDB 버퍼 풀`의 공간을 더 확보

### 4. 테이블 압축 관련 설정

---

- 테이블 압축을 사용할 때 연관된 시스템 변수가 몇 가지 있는데, 이는 모두 페이지의 압축 실패율을 낮추기 위한 튜닝 포인트를 제공

- `innodb_cmp_per_index_enalbed`
- `innodb_compression_level`
- `innodb_compression_failure_threshold_pct`와 `innodb_compression_pac_pct_max`
- `innodb_log_compressed_pages`